/* 
 * mBounce v0.1.0 
 * Author: @Mark Zhou 
 * Date: 2014-04-04 
 * Url:  
 * Licensed under the MIT license
 */
$(function(){"use strict";var a=function(a){function b(a,b){var c=g(40,100),d=g(0,200);return j.status.stairsInfo.push({index:a,bottom:b+j.config.stairHeight,left_min:d,left_max:d+c}),$("<div>").addClass("stair").attr("id","stair-"+a).css({bottom:b+"px",width:c,left:d})}function c(a){j.status.stairsInfo.forEach(function(b,c){b.index===a&&(j.status.stairsInfo.splice(c,1),$("#stair-"+a).remove())})}function d(a,d){j.status.stairsInfo.forEach(function(e){e.bottom-=a,$("#stair-"+e.index).animate({bottom:e.bottom},{duration:d,easing:"linear",complete:function(){if(e.bottom<0){c(e.index);var a=j.status.stairsInfo[j.status.stairsInfo.length-1],d=b(a.index+1,a.bottom+j.config.stairHeightDiff);j.$game.prepend(d)}}})})}function e(a,b){var c;return j.status.stairsInfo.forEach(function(d){return a<=d.bottom+j.config.stairToleranceUp&&a>=d.bottom-j.config.stairHeight-j.config.stairToleranceDown&&b>d.left_min&&b<d.left_max?(c=d,!1):void 0}),c}function f(a){return parseInt(a.substr(0,a.length-2),10)}function g(a,b){return Math.floor(Math.random()*(b-a+1))+a}var h=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}(),i={},j=this;this.config={boardWidth:300,boardHeight:400,characterWidth:42,characterHeight:30,leapLeft:10,leapUp:100,leapUpDruation:600,leapDownDuration:600,stairHeight:15,stairHeightDiff:60,stairToleranceUp:5,stairToleranceDown:5,stairInitNumber:8},this.init=function(){return this.registerKeyEvents(),this.$character=$("#character"),this.$game=$("#game"),this.$score=$("#score span"),this.resetStatus(),this},this.start=function(){return this.status.isGameOver=!1,this.drawStairs(),this.gameLoop(),this.characterFly(),this.leap(),this},this.registerKeyEvents=function(){window.addEventListener("keydown",function(a){i[a.keyCode||a.which]=!0},!0),window.addEventListener("keyup",function(a){i[a.keyCode||a.which]=!1},!0)},this.drawStairs=function(){for(var a=[],c=0;c<this.config.stairInitNumber;c++)a.push(b(c,(c+1)*this.config.stairHeightDiff));this.$game.prepend(a)},this.gameLoop=function(){!function a(){j.status.isGameOver||h(a),j.characterHorizontalMove(),j.stairUpCheck()}()},this.characterFly=function(){var a=!0,b=setInterval(function(){if(j.status.isGameOver)return void clearInterval(b);var c,d=parseInt(j.$character.attr("class").match(/\d/)[0],10);0===d||2===d?(c=1,a=!a):c=a?0:2,j.$character.removeClass("status-0 status-1 status-2").addClass("status-"+c)},200)},this.leap=function(){this.leapUp(),this.leapDown()},this.leapUp=function(){var a,b,c,e=f(this.$character.css("bottom")),g=!1;e+this.config.leapUp<this.config.boardHeight/2?(a=this.config.leapUp,b=this.config.leapUpDruation,this.status.delay=0):(g=!0,a=this.config.boardHeight/2-e,b=Math.floor(this.config.leapUpDruation*a/this.config.leapUp),c=this.config.leapUp-a,this.status.delay=this.config.leapUpDruation-b),this.$character.animate({bottom:"+="+a},{duration:b,easing:"swing",start:function(){j.status.isGoingDown=!1},complete:function(){j.status.bottom=e+a,g&&d(c,j.status.delay)}})},this.leapDown=function(){this.$character.delay(this.status.delay).animate({bottom:0},{duration:this.config.leapDownDuration*this.status.bottom/this.config.leapUp,easing:"swing",start:function(){j.status.isGoingDown=!0},complete:function(){j.status.score>0?j.gameOver():j.leap()}})},this.characterHorizontalMove=function(){var a,b=f(this.$character.css("left"));(i[37]||i[65])&&(this.$character.addClass("left"),a=b>=this.config.leapLeft?b-this.config.leapLeft:0),(i[39]||i[68])&&(this.$character.removeClass("left"),a=b<=this.config.boardWidth-this.config.characterWidth-this.config.leapLeft?b+this.config.leapLeft:this.config.boardWidth-this.config.characterWidth),this.$character.css("left",a)},this.stairUpCheck=function(){if(this.status.isGoingDown){var a=f(this.$character.css("bottom")),b=f(this.$character.css("left")),c=e(a,b);c&&(this.$character.stop(),this.updateScore(c),this.leap())}},this.updateScore=function(a){var b=parseInt(this.$score.html(),10);b<a.index&&(this.status.score=a.index,this.$score.html(a.index))},this.gameOver=function(){$(".overlay",this.$game).show(),this.status.isGameOver=!0,this.$game.on("click",".play-again",function(){j.restart(),$(".overlay",j.$game).hide()})},this.restart=function(){$(".stair",this.$game).remove(),this.$score.html(0),this.resetStatus(),this.start()},this.resetStatus=function(){this.status={score:0,isGameOver:!0,bottom:this.config.leapUp,stairsInfo:[]}},this.init(a)};window.Game=a});
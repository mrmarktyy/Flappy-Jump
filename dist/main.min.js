/* 
 * Flappy-Jump v0.5.0 
 * Author: @Mark Zhou 
 * Url: git://github.com/mrmarktyy/Flappy-Jump.git 
 * Licensed under the MIT license
 */
$(function(){"use strict";var a=1e3,b=function(b){function c(a){return parseInt(a.substr(0,a.length-2),10)}function d(a,b){return Math.floor(Math.random()*(b-a+1))+a}function e(a,b){return{a_up:Math.floor(-2*b/a/a),a_down:Math.floor(2*b/a/a),v:Math.floor(2*b/a)}}var f=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}(),g={},h={},i=this;this.config={boardWidth:320,boardHeight:480,characterWidth:42,characterHeight:30,gammaLeft:-25,gammaRight:25,leapHeight:140,leapDuration:.7,leapLeft:10,leapInterval:50,stairWidth:80,stairLeftMin:0,stairLeftMax:220,stairHeight:30,stairHeightDiff:100,stairToleranceUp:5,stairToleranceDown:15,stairNumber:8,stairP:40,stairMoveSpeed:4},this.init=function(){return this.setConfig(),this.$game=$("#game"),this.$game.css({height:this.config.boardHeight,width:this.config.boardWidth}),this.registerEvents(),this},this.setConfig=function(){this.setViewPort(),this.setVA(this.config.leapDuration,this.config.leapHeight)},this.setViewPort=function(){var b=$(window).width(),c=$(window).height();a>b&&(this.config.boardWidth=b,this.config.boardHeight=c,this.config.stairLeftMax=this.config.boardWidth-this.config.stairWidth)},this.setVA=function(a,b){var c=e(a,b);this.config.v0=c.v,this.config.a_down=c.a_down,this.config.a_up=c.a_up},this.registerEvents=function(){window.addEventListener("keydown",function(a){g[a.keyCode||a.which]=!0},!0),window.addEventListener("keyup",function(a){g[a.keyCode||a.which]=!1},!0),window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",function(a){a.gamma<i.config.gammaLeft?(h.left=!0,h.right=!1):a.gamma>i.config.gammaRight?(h.right=!0,h.left=!1):(h.right=!1,h.left=!1)},!1),$(document).on("click","#menu .go",function(){i.start()}),$(document).on("click","#game .again",function(){i.showMenu()})},this.showMenu=function(){$("#game").empty().append($("#menu-tpl").html())},this.start=function(){return this.setDOM(),this.resetStatus(),this.drawStairs(),this.gameLoop(),this.leap(),this},this.setDOM=function(){$("#menu").replaceWith($("#main-tpl").html()),this.$character=$("#character"),this.$score=$("#score span"),this.$best=$("#best span"),this.audioWing=document.getElementById("audio-wing"),this.audioHit=document.getElementById("audio-hit"),this.audioWing.play(),this.audioWing.pause(),this.audioHit.play(),this.audioHit.pause()},this.resetStatus=function(){this.status={score:0,isGameOver:!1,isGoingDown:!1,changeDirection:!0,t0:+new Date,bottom:0,stairsInfo:[]},g={},h={},$(".stair",this.$game).remove(),this.$score.html(0),this.$best.html(this.getBest()),this.$character.addClass("swing")},this.gameOver=function(){this.audioHit.play(),$(".overlay",this.$game).show(),$(".overlay .game-over span",this.$game).html(this.status.score),this.$character.removeClass("swing"),this.status.isGameOver=!0},this.drawStairs=function(){for(var a=[],b=0;b<this.config.stairNumber;b++)a.push(this.createStair(b,(b+1)*this.config.stairHeightDiff));this.$game.prepend(a)},this.getLastStair=function(){return this.status.stairsInfo[this.status.stairsInfo.length-1]},this.createStair=function(a,b){var c=this.config.stairWidth,e=d(this.config.stairLeftMin,this.config.stairLeftMax),f={index:a,bottom:b,top:b+this.config.stairHeight,width:c,left_min:e,left_max:e+c};return a>10&&d(1,100)<=this.config.stairP&&(f.moveable=!0,f.direction=c%2?!0:!1),this.status.stairsInfo.push(f),$("<div>").addClass("stair").attr("id","stair-"+a).css({bottom:b+"px",width:c,left:e})},this.removeStair=function(a){for(var b=0,c=this.status.stairsInfo.length-1;c>b;b++){var d=this.status.stairsInfo[b];d.index===a&&(i.status.stairsInfo.splice(b,1),$("#stair-"+a).remove())}},this.stairsMoveDown=function(a){this.status.stairsInfo.forEach(function(b){$("#stair-"+b.index).css("bottom",b.bottom-a+"px")})},this.updateStairsInfo=function(){var a=[];this.status.stairsInfo.forEach(function(b){var d=c($("#stair-"+b.index).css("bottom"));0>d?a.push(b):(b.bottom=d,b.top=d+i.config.stairHeight)}),a.forEach(function(a){i.removeStair(a.index);var b=i.getLastStair(),c=i.createStair(b.index+1,b.top+i.config.stairHeightDiff);i.$game.prepend(c)})},this.stairUpCheck=function(a){var b=c(this.$character.css("left")),d=this.checkStairUp(a,b+this.config.characterWidth/2);d&&(this.updateScore(d),this.status.isGoingDown=!1,this.status.changeDirection=!0)},this.checkStairUp=function(a,b){var c;return this.status.stairsInfo.forEach(function(d){return a<=d.top+i.config.stairToleranceUp&&a>=d.top-i.config.stairToleranceDown&&b>d.left_min&&b<d.left_max?(c=d,!1):void 0}),c},this.moveableStairs=function(){this.status.stairsInfo.forEach(function(a){if(a.moveable){var b,c=a.left_min;a.direction?c>i.config.stairMoveSpeed?b=c-i.config.stairMoveSpeed:(b=0,a.direction=!a.direction):c<i.config.boardWidth-a.width-i.config.stairMoveSpeed?b=c+i.config.stairMoveSpeed:(b=i.config.boardWidth-a.width,a.direction=!a.direction),$("#stair-"+a.index).css("left",b+"px"),a.left_min=b,a.left_max=b+a.width}})},this.gameLoop=function(){!function a(){i.status.isGameOver||f(a),i.characterHorizontalMove(),i.moveableStairs()}()},this.leap=function(){this.times=0,this.interval=setInterval(function(){i.status.changeDirection&&(i.status.t0=+new Date,i.status.curBottom=c(i.$character.css("bottom")),i.status.changeDirection=!1,i.status.isGoingDown||i.audioWing.play()),i.status.isGoingDown?i.leapDown():i.leapUp(),i.status.isGameOver&&clearInterval(i.interval)},this.config.leapInterval)},this.leapUp=function(){var a=(+new Date-this.status.t0)/1e3,b=this.config.v0+this.config.a_up*a,c=this.config.v0*a+this.config.a_up*a*a/2;if(0>b)this.updateStairsInfo(),this.status.isGoingDown=!0,this.status.changeDirection=!0;else{var d=Math.ceil(this.status.curBottom+c-this.config.boardHeight/2);d>0?(this.$character.css("bottom",this.config.boardHeight/2+"px"),this.stairsMoveDown(d)):this.$character.css("bottom",this.status.curBottom+c+"px")}},this.leapDown=function(){var a=(+new Date-this.status.t0)/1e3,b=this.config.a_down*a*a/2,c=this.status.curBottom-b;0>c?(this.$character.css("bottom",0),this.status.score>0?this.gameOver():(this.status.isGoingDown=!1,this.status.changeDirection=!0)):(this.$character.css("bottom",c+"px"),this.stairUpCheck(c))},this.characterHorizontalMove=function(){var a,b=c(this.$character.css("left"));(g[37]||g[65]||h.left)&&(this.$character.addClass("left"),a=b>=this.config.leapLeft?b-this.config.leapLeft:0),(g[39]||g[68]||h.right)&&(this.$character.removeClass("left"),a=b<=this.config.boardWidth-this.config.characterWidth-this.config.leapLeft?b+this.config.leapLeft:this.config.boardWidth-this.config.characterWidth),this.$character.css("left",a)},this.updateScore=function(a){var b=a.index+1;this.status.score<b&&(this.status.score=b,this.$score.html(b)),this.getBest()<b&&this.setBest(b)},this.getBest=function(){return localStorage?localStorage.getItem("best")||0:0},this.setBest=function(a){localStorage&&localStorage.setItem("best",a),this.$best.html(a)},this.init(b)};window.Game=b});
/* 
 * mBounce v0.1.0 
 * Author: @Mark Zhou 
 * Date: 2014-04-05 
 * Url:  
 * Licensed under the MIT license
 */
$(function(){"use strict";var a=function(a){function b(a,b){var c=d(40,100),e=d(0,200);return h.status.stairsInfo.push({index:a,bottom:b,top:b+h.config.stairHeight,left_min:e,left_max:e+c}),$("<div>").addClass("stair").attr("id","stair-"+a).css({bottom:b+"px",width:c,left:e})}function c(a){return parseInt(a.substr(0,a.length-2),10)}function d(a,b){return Math.floor(Math.random()*(b-a+1))+a}function e(a,b){return{a_up:Math.floor(-2*b/a/a),a_down:Math.floor(2*b/a/a),v:Math.floor(2*b/a)}}var f=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}(),g={},h=this;this.config={boardWidth:300,boardHeight:400,characterWidth:42,characterHeight:30,leapUp:100,leapDuration:.6,leapLeft:10,leapInterval:40,stairHeight:15,stairHeightDiff:60,stairToleranceUp:5,stairToleranceDown:15,stairInitNumber:8},this.init=function(){var a=e(this.config.leapDuration,this.config.leapUp);return this.config.v0=a.v,this.config.a_down=a.a_down,this.config.a_up=a.a_up,this.registerKeyEvents(),this.$character=$("#character"),this.$game=$("#game"),this.$score=$("#score span"),this.resetStatus(),this},this.start=function(){return this.status.isGameOver=!1,this.drawStairs(),this.gameLoop(),this.characterFly(),this.leap(),this},this.registerKeyEvents=function(){window.addEventListener("keydown",function(a){g[a.keyCode||a.which]=!0},!0),window.addEventListener("keyup",function(a){g[a.keyCode||a.which]=!1},!0)},this.drawStairs=function(){for(var a=[],c=0;c<this.config.stairInitNumber;c++)a.push(b(c,(c+1)*this.config.stairHeightDiff));this.$game.prepend(a)},this.getLastStair=function(){return this.status.stairsInfo[this.status.stairsInfo.length-1]},this.removeStair=function(a){this.status.stairsInfo.forEach(function(b,c){b.index===a&&(h.status.stairsInfo.splice(c,1),$("#stair-"+a).remove())})},this.stairsMoveDown=function(a){this.status.stairsInfo.forEach(function(b){$("#stair-"+b.index).css("bottom",b.bottom-a+"px")})},this.updateStairsInfo=function(){var a=[];this.status.stairsInfo.forEach(function(b){var d=c($("#stair-"+b.index).css("bottom"));0>d?a.push(b):(b.bottom=d,b.top=d+h.config.stairHeight)}),a.forEach(function(a){h.removeStair(a.index);var c=h.getLastStair(),d=b(c.index+1,c.top+h.config.stairHeightDiff);h.$game.prepend(d)})},this.checkStairUp=function(a,b){var c;return this.status.stairsInfo.forEach(function(d){return a<=d.top+h.config.stairToleranceUp&&a>=d.top-h.config.stairToleranceDown&&b>d.left_min&&b<d.left_max?(c=d,!1):void 0}),c},this.gameLoop=function(){!function a(){h.status.isGameOver||f(a),h.characterHorizontalMove()}()},this.characterFly=function(){var a=!0,b=setInterval(function(){if(h.status.isGameOver)return void clearInterval(b);var c,d=parseInt(h.$character.attr("class").match(/\d/)[0],10);0===d||2===d?(c=1,a=!a):c=a?0:2,h.$character.removeClass("status-0 status-1 status-2").addClass("status-"+c)},200)},this.leap=function(){this.interval=setInterval(function(){h.status.isChanged&&(h.status.t0=+new Date,h.status.curBottom=c(h.$character.css("bottom")),h.status.isChanged=!1),h.status.isGoingDown?h.leapDown():h.leapUp(),h.status.isGameOver&&clearInterval(h.interval)},this.config.leapInterval)},this.leapUp=function(){var a=(+new Date-this.status.t0)/1e3,b=this.config.v0+this.config.a_up*a,c=this.config.v0*a+this.config.a_up*a*a/2;if(0>b)this.updateStairsInfo(),this.status.isGoingDown=!0,this.status.isChanged=!0;else{var d=Math.ceil(this.status.curBottom+c-this.config.boardHeight/2);d>0?(this.$character.css("bottom",this.config.boardHeight/2+"px"),this.stairsMoveDown(d)):this.$character.css("bottom",this.status.curBottom+c+"px")}},this.leapDown=function(){var a=(+new Date-this.status.t0)/1e3,b=this.config.a_down*a*a/2,c=this.status.curBottom-b;0>c?(this.$character.css("bottom",0),this.status.score>0?this.gameOver():(this.status.isGoingDown=!1,this.status.isChanged=!0)):(this.$character.css("bottom",c+"px"),this.stairUpCheck(c))},this.characterHorizontalMove=function(){var a,b=c(this.$character.css("left"));(g[37]||g[65])&&(this.$character.addClass("left"),a=b>=this.config.leapLeft?b-this.config.leapLeft:0),(g[39]||g[68])&&(this.$character.removeClass("left"),a=b<=this.config.boardWidth-this.config.characterWidth-this.config.leapLeft?b+this.config.leapLeft:this.config.boardWidth-this.config.characterWidth),this.$character.css("left",a)},this.stairUpCheck=function(a){var b=c(this.$character.css("left")),d=this.checkStairUp(a,b+this.config.characterWidth/2);d&&(this.updateScore(d),this.status.isGoingDown=!1,this.status.isChanged=!0)},this.updateScore=function(a){var b=a.index+1;this.status.score<b&&(this.status.score=b,this.$score.html(b))},this.gameOver=function(){$(".overlay",this.$game).show(),this.status.isGameOver=!0,this.$game.on("click",".play-again",function(){h.restart(),$(".overlay",h.$game).hide()})},this.restart=function(){this.resetStatus(),this.start()},this.resetStatus=function(){this.status={score:0,isGameOver:!0,isGoingDown:!1,isChanged:!0,t0:+new Date,bottom:0,stairsInfo:[]},$(".stair",this.$game).remove(),this.$score.html(0),this.$character.attr("class","status-1").css({bottom:"0px",left:"145px"})},this.init(a)};window.Game=a});